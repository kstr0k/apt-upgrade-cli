#!/bin/sh
set -e; set -u

# License = MIT
# Author = https://gitlab.com/almr/
# Homepage = https://gitlab.com/almr/apt-upgrade-cli/

# https://unix.stackexchange.com/questions/603514/apt-upgrade-package-without-marking-as-manually-installed

# TODO: apt options

DEFSTATUS=off
while test $# -gt 0; do
  case "$1" in
    --all) DEFSTATUS=on; shift ;;
    --help|-h) printf "Args: [-u|--update] [--all] [pkg ...]\n"; exit 0 ;;
    --update|-u) apt update; shift ;;
    --) shift; break ;;
    -*) echo "Unknown: $1"; exit 1 ;;
    *) break ;;
  esac
done

upgable2pkgs () (
  perl -wlnE 'print $1 if m@^([^/]+)/.*\bupgradable @'  # apt is not scriptable by its own confession; format: linux-doc/focal-updates 5.4.0-59.65 all [upgradable from: 5.4.0-58.64]
)

dialog_sel_pkgs () (
  US=$(upgable2pkgs)
  test -z "$US" && return
  for u in $US; do set -- "$@" "$u" '' "$DEFSTATUS"; done
  dialog --stdout --separate-output --checklist 'Upgrade' 0 0 0 "$@"
)

sel_pkgs () (
  apt list --upgradeable 2>/dev/null |
    dialog_sel_pkgs
)

test $# -eq 0 && set -- $(sel_pkgs)  # TODO: expand patterns if $# > 0
test $# -eq 0 && { echo 'No upgrades available' 1>&2; exit; }

AUTOS=$(apt-mark showauto "$@")
clear
(set -x; apt install --no-install-recommends "$@")
test -n "$AUTOS" && apt-mark auto $AUTOS >/dev/null
